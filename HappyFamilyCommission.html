<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Family Commission Agency</title>
    <link rel="stylesheet" href="HappyFamilyCommission.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!--PAGE 1: LOGIN PAGE (Visible by default)-->
    <div id="loginPage">
        <div class="container login-container">
            <header class="company-header">
                <div class="company-logo">
                    <i class="fas fa-hands-helping"></i>
                    <h1>Happy Family Commission Agency Limited</h1>
                </div>
                <p class="company-tagline">Building Wealth, One Day at a Time</p>
            </header>

            <div class="main-content">
                <div class="company-info">
                    <h2><i class="fas fa-bullseye"></i> Our Mission</h2>
                    <p>Provide a simple, convenient, and rewarding way for individuals to save and invest regularly.</p>

                    <h2><i class="fas fa-cogs"></i> How It Works</h2>
                    <ol>
                        <li>Register as a member</li>
                        <li>Choose your daily contribution amount</li>
                        <li>Make daily contributions at our branches</li>
                        <li>Watch your savings grow</li>
                    </ol>

                    <h2><i class="fas fa-map-marker-alt"></i> Our Location</h2>
                    <p><i class="fas fa-store"></i> Tools and Motor Spare parts, Effurun, Warri, Delta State</p>

                    <h2><i class="fas fa-phone"></i> Contact Us</h2>
                    <div class="contact-details">
                        <p><i class="fas fa-phone-square"></i> 08037969203</p>
                        <p><i class="fas fa-phone-square"></i> 08108062640</p>
                        <p><i class="fas fa-envelope"></i> info@happyfamilyagency.com</p>
                    </div>
                </div>

                <div class="login-form-container">
                    <div class="login-card">
                        <h2><i class="fas fa-sign-in-alt"></i> Member Login</h2>
                        <p class="login-subtitle">Access your contribution dashboard</p>

                        <form id="loginForm">
                            <div class="form-group">
                                <label for="username"><i class="fas fa-user"></i> Username / Email</label>
                                <input type="text" id="username" placeholder="Enter your username or email" required>
                            </div>

                            <div class="form-group">
                                <label for="password"><i class="fas fa-lock"></i> Password</label>
                                <input type="password" id="password" placeholder="Enter your password" required>
                            </div>

                            <div class="form-options">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="rememberMe">
                                    <span class="checkmark"></span>
                                    Remember me
                                </label>
                                <a href="#" class="forgot-password">Forgot Password?</a>
                            </div>

                            <button type="submit" class="btn-login">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>

                            <div class="demo-credentials">
                                <h3><i class="fas fa-info-circle"></i> Demo Credentials:</h3>
                                <p><strong>Admin:</strong> admin / admin123</p>
                                <p><strong>User:</strong> user1 / user123</p>
                            </div>
                        </form>

                        <div class="login-footer">
                            <p>New to Happy Family? <a href="#" id="registerLink">Contact admin for registration</a></p>
                            <p class="security-note"><i class="fas fa-shield-alt"></i> Secure login system</p>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="main-footer">
                <p>&copy; 2025 Happy Family Commission Agency Limited.<br> All rights reserved.</p>
                <p>Daily Contribution System v1.0</p>
                <p>Copyright MalcNelxus Technologies Limited</p>
            </footer>
        </div>
    </div>

    <!--PAGE 2: ADMIN DASHBOARD (Hidden by default)-->
    <div id="adminPage" style="display: none;">
        <nav class="top-nav">
            <div class="nav-brand">
                <i class="fas fa-hands-helping"></i>
                <h2>Happy Family Agency - Admin Panel</h2>
            </div>
            <div class="nav-user">
                <span class="user-welcome"><i class="fas fa-user-shield"></i> Admin User</span>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <div class="container dashboard-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Dashboard Menu</h3>
                </div>
                <ul class="sidebar-menu">
                    <li class="active"><a href="#"><i class="fas fa-users"></i> User Management</a></li>
                    <li><a href="#"><i class="fas fa-chart-line"></i> Reports</a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i> Help</a></li>
                </ul>

                <div class="sidebar-stats">
                    <h4><i class="fas fa-chart-pie"></i> Quick Stats</h4>
                    <div class="stat-item">
                        <span>Total Users</span>
                        <strong id="totalUsers">12</strong>
                    </div>
                    <div class="stat-item">
                        <span>Total Balance</span>
                        <strong id="totalBalance">₦245,800</strong>
                    </div>
                    <div class="stat-item">
                        <span>Today's Deposits</span>
                        <strong id="todayDeposits">₦18,500</strong>
                    </div>
                </div>
            </aside>

            <main class="main-dashboard">
                <div class="dashboard-header">
                    <h1><i class="fas fa-users-cog"></i> User Management</h1>
                    <div class="dashboard-actions">
                        <button class="btn-add-user" id="addUserBtn">
                            <i class="fas fa-user-plus"></i> Register New User
                        </button>
                        <button class="btn-add-user" id="manageDepositsBtn">
                            <i class="fas fa-money-bill-wave"></i> Manage Deposits
                        </button>
                        <button class="btn-add-user" id="manageWithdrawalsBtn">
                            <i class="fas fa-hand-holding-usd"></i> Manage Withdrawals
                        </button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Registered Users</h3>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="userSearch" placeholder="Search users...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Full Name</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Daily Amount</th>
                                    <th>Balance</th>
                                    <th>Last Deposit</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody"></tbody>
                        </table>
                    </div>

                    <div class="table-footer">
                        <div class="pagination">
                            <button class="btn-pagination" disabled><i class="fas fa-chevron-left"></i> Prev</button>
                            <span class="page-info">Page 1 of 2</span>
                            <button class="btn-pagination">Next <i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="table-summary">
                            Showing <strong>8</strong> of <strong>12</strong> users
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="action-card">
                        <i class="fas fa-file-export"></i>
                        <h4>Export Data</h4>
                        <p>Export user data to Excel</p>
                    </div>
                    <div class="action-card">
                        <i class="fas fa-print"></i>
                        <h4>Print Reports</h4>
                        <p>Generate printable reports</p>
                    </div>
                    <div class="action-card">
                        <i class="fas fa-bell"></i>
                        <h4>Notifications</h4>
                        <p>Send alerts to users</p>
                    </div>
                    <div class="action-card" id="depositOverviewBtn">
                        <i class="fas fa-calendar-check"></i>
                        <h4>Deposit Overview</h4>
                        <p>View all user deposit status</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Add User Modal -->
        <div class="modal-overlay" id="userModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-user-plus"></i> Register New User</h3>
                    <button class="modal-close" id="closeModal">&times;</button>
                </div>
                <form id="addUserForm">
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newFullName"><i class="fas fa-user"></i> Full Name *</label>
                                <input type="text" id="newFullName" required>
                            </div>
                            <div class="form-group">
                                <label for="newUsername"><i class="fas fa-at"></i> Username *</label>
                                <input type="text" id="newUsername" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmail"><i class="fas fa-envelope"></i> Email Address</label>
                                <input type="email" id="newEmail">
                            </div>
                            <div class="form-group">
                                <label for="newPhone"><i class="fas fa-phone"></i> Phone Number *</label>
                                <input type="tel" id="newPhone" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newPassword"><i class="fas fa-lock"></i> Initial Password *</label>
                                <input type="password" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="dailyProposedAmount"><i class="fas fa-money-bill-wave"></i> Daily Proposed Amount (₦) *</label>
                                <input type="number" id="dailyProposedAmount" min="200" required value="1000">
                                <small>Minimum: ₦200</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="userRole"><i class="fas fa-user-tag"></i> User Role</label>
                                <select id="userRole">
                                    <option value="user">Regular User</option>
                                    <option value="agent">Collection Agent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" id="cancelModal">Cancel</button>
                        <button type="submit" class="btn-save">Register User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Deposit Management Modal -->
        <div class="modal-overlay calendar-modal" id="depositModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-money-bill-wave"></i> Manage Deposits</h3>
                    <button class="modal-close" id="closeDepositModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="user-info-header">
                        <div>
                            <h4 id="depositUserName">Loading user...</h4>
                            <p class="proposed-amount-display" id="depositUserAmount">Daily Amount: ₦0</p>
                        </div>
                        <div class="year-selector">
                            <label for="depositYearSelect"><i class="fas fa-calendar"></i> Year:</label>
                            <select id="depositYearSelect"></select>
                        </div>
                    </div>

                    <div class="calendar-controls">
                        <button class="btn-action btn-edit" id="saveDepositsBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <div class="legend">
                            <span class="legend-item deposited">
                                <i class="fas fa-square"></i> Deposited
                            </span>
                            <span class="legend-item not-deposited">
                                <i class="fas fa-square"></i> Not Deposited
                            </span>
                        </div>
                    </div>

                    <div class="months-container" id="depositMonthsContainer"></div>
                </div>
                <div class="modal-footer">
                    <div class="modal-footer-content">
                        <div class="totals">
                            <strong>Yearly Total:</strong> <span id="depositYearlyTotal">₦0</span>
                        </div>
                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" id="cancelDepositModal">Cancel</button>
                            <button type="button" class="btn-save" id="confirmDepositModal">Confirm Deposits</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdrawal Management Modal -->
        <div class="modal-overlay calendar-modal" id="withdrawalModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-hand-holding-usd"></i> Manage Withdrawals</h3>
                    <button class="modal-close" id="closeWithdrawalModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="user-info-header">
                        <div>
                            <h4 id="withdrawalUserName">Loading user...</h4>
                            <p class="proposed-amount-display" id="withdrawalUserAmount">Daily Amount: ₦0</p>
                        </div>
                        <div class="year-selector">
                            <label for="withdrawalYearSelect"><i class="fas fa-calendar"></i> Year:</label>
                            <select id="withdrawalYearSelect"></select>
                        </div>
                    </div>

                    <div class="calendar-controls">
                        <button class="btn-action btn-edit" id="saveWithdrawalsBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <div class="legend">
                            <span class="legend-item deposited">
                                <i class="fas fa-square"></i> Deposited
                            </span>
                            <span class="legend-item withdrawn">
                                <i class="fas fa-square"></i> Withdrawn
                            </span>
                            <span class="legend-item not-withdrawn">
                                <i class="fas fa-square"></i> Not Withdrawn
                            </span>
                        </div>
                    </div>

                    <div class="months-container" id="withdrawalMonthsContainer"></div>

                    <div class="form-group">
                        <label for="withdrawalReason"><i class="fas fa-comment"></i> Reason for Withdrawal (Optional)</label>
                        <textarea id="withdrawalReason" class="withdrawal-reason" placeholder="Enter reason for withdrawal..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="modal-footer-content">
                        <div class="totals">
                            <strong>Yearly Withdrawn:</strong> <span id="withdrawalYearlyTotal">₦0</span>
                        </div>
                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" id="cancelWithdrawalModal">Cancel</button>
                            <button type="button" class="btn-save" id="confirmWithdrawalModal">Confirm Withdrawals</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <p>&copy; 2025 Happy Family Commission Agency Limited.<br>

                <p>Copyright MalcNelxus Technologies Limited</p><br> All rights reserved.</p>
            <p>Admin Dashboard v1.0 | Deposit Tracking System v2.0</p>
        </footer>
    </div>

    <!--PAGE 3: USER DASHBOARD (Hidden by default)-->
    <div id="userPage" style="display: none;">
        <nav class="top-nav">
            <div class="nav-brand">
                <i class="fas fa-hands-helping"></i>
                <h2>Happy Family Commission Agency</h2>
            </div>
            <div class="nav-user">
                <span class="user-welcome"><i class="fas fa-user"></i> Welcome, <span id="currentUserName">John Doe</span></span>
                <button class="btn-logout" id="userLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <div class="container user-container">
            <aside class="user-sidebar">
                <div class="user-profile">
                    <div class="profile-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h3 id="displayUserName">John Doe</h3>
                    <p class="user-id">Member ID: HFCA-0012</p>
                    <div class="profile-status">
                        <span class="status-active"><i class="fas fa-circle"></i> Active Member</span>
                    </div>
                </div>

                <ul class="user-menu">
                    <li class="active"><a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#"><i class="fas fa-history"></i> Contribution History</a></li>
                    <li><a href="#"><i class="fas fa-chart-line"></i> Progress</a></li>
                    <li><a href="#"><i class="fas fa-user-edit"></i> Profile</a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i> Help Center</a></li>
                </ul>

                <div class="sidebar-info">
                    <h4><i class="fas fa-info-circle"></i> Quick Info</h4>
                    <p>Daily contributions should be made before 6 PM at any branch.</p>
                    <p>Contact admin for any account issues.</p>
                </div>
            </aside>

            <main class="user-main">
                <div class="welcome-banner">
                    <div class="welcome-text">
                        <h1><i class="fas fa-hand-holding-heart"></i> Your Contribution Dashboard</h1>
                        <p>Track your daily savings and financial progress</p>
                    </div>
                    <div class="current-date">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="todayDate">Loading...</span>
                    </div>
                </div>

                <div class="balance-cards">
                    <div class="balance-card primary">
                        <div class="card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="card-content">
                            <h3>Current Balance</h3>
                            <p class="balance-amount" id="currentBalance">₦ 45,200</p>
                            <p class="balance-info">Available for withdrawal</p>
                        </div>
                    </div>

                    <div class="balance-card secondary">
                        <div class="card-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="card-content">
                            <h3>Daily Target</h3>
                            <p class="balance-amount" id="dailyTargetAmount">₦ 1,000</p>
                            <p class="balance-info">Per day contribution</p>
                        </div>
                    </div>

                    <div class="balance-card accent">
                        <div class="card-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="card-content">
                            <h3>Current Streak</h3>
                            <p class="balance-amount">24 Days</p>
                            <p class="balance-info">Consistent contributions</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-exchange-alt"></i> Recent Transactions</h3>
                        <div class="time-filter">
                            <select id="timeFilter">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction ID</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Balance After</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTableBody"></tbody>
                        </table>
                    </div>

                    <div class="table-footer">
                        <div class="pagination">
                            <button class="btn-pagination" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                            <span class="page-info">Page 1 of 1</span>
                            <button class="btn-pagination">Next <i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="summary">
                            <p><strong>Total Deposits (30 days):</strong> <span id="totalDeposits30Days">₦ 30,000</span></p>
                        </div>
                    </div>
                </div>

                <div class="summary-cards">
                    <div class="summary-card">
                        <h4><i class="fas fa-chart-bar"></i> This Month</h4>
                        <div class="summary-content">
                            <div class="summary-item">
                                <span>Contributions Made</span>
                                <strong id="contributionsThisMonth">22/30 days</strong>
                            </div>
                            <div class="summary-item">
                                <span>Total Deposited</span>
                                <strong id="totalThisMonth">₦ 22,000</strong>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 73%" id="monthProgress"></div>
                            </div>
                            <p class="progress-text" id="monthProgressText">73% monthly target achieved</p>
                        </div>
                    </div>

                    <div class="summary-card">
                        <h4><i class="fas fa-trophy"></i> Achievement</h4>
                        <div class="summary-content">
                            <div class="achievement">
                                <i class="fas fa-medal"></i>
                                <div>
                                    <strong>Gold Saver</strong>
                                    <p>Consistent for 3 months</p>
                                </div>
                            </div>
                            <div class="achievement">
                                <i class="fas fa-star"></i>
                                <div>
                                    <strong>Early Bird</strong>
                                    <p>On-time payments</p>
                                </div>
                            </div>
                            <div class="next-milestone">
                                <p><i class="fas fa-flag"></i> Next milestone: ₦50,000 balance</p>
                            </div>
                        </div>
                    </div>

                    <div class="summary-card">
                        <h4><i class="fas fa-calendar-day"></i> Today's Status</h4>
                        <div class="summary-content">
                            <div class="today-status">
                                <i class="fas fa-check-circle status-done"></i>
                                <div>
                                    <strong>Contribution Made</strong>
                                    <p id="todayContributionInfo">Today, 10:30 AM at Main Branch</p>
                                </div>
                            </div>
                            <div class="branch-info">
                                <p><i class="fas fa-map-marker-alt"></i> <strong>Nearest Branch:</strong> Effurun Main</p>
                                <p><i class="fas fa-clock"></i> <strong>Hours:</strong> 8AM - 6PM</p>
                            </div>
                            <button class="btn-receipt">
                                <i class="fas fa-receipt"></i> View Today's Receipt
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <footer class="user-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4><i class="fas fa-phone"></i> Need Help?</h4>
                    <p>08037969203</p>
                    <p>08108062640</p>
                </div>
                <div class="footer-section">
                    <h4><i class="fas fa-exclamation-circle"></i> Important Notice</h4>
                    <p>Only admins can register new users. Contact branch for assistance.</p>
                </div>
                <div class="footer-section">
                    <p>&copy; 2025 Happy Family Commission Agency</p>
                    <p>Your financial growth partner</p>
                    <p>Copyright MalcNelxus Technologies Limited</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let selectedUserForCalendar = null;
        let currentYear = new Date().getFullYear();

        // Demo User Data
        const demoUsers = [{
            id: 1,
            fullName: "John Doe",
            username: "user1",
            email: "john@example.com",
            phone: "08012345678",
            dailyProposedAmount: 1000,
            balance: 45200,
            status: "active",
            lastDeposit: "2023-10-15",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 2,
            fullName: "Jane Smith",
            username: "user2",
            email: "jane@example.com",
            phone: "08023456789",
            dailyProposedAmount: 2000,
            balance: 32000,
            status: "active",
            lastDeposit: "2023-10-14",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 3,
            fullName: "Mike Johnson",
            username: "mikej",
            email: "mike@example.com",
            phone: "08034567890",
            dailyProposedAmount: 500,
            balance: 15600,
            status: "active",
            lastDeposit: "2023-10-13",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 4,
            fullName: "Sarah Williams",
            username: "sarahw",
            email: "sarah@example.com",
            phone: "08045678901",
            dailyProposedAmount: 1500,
            balance: 89000,
            status: "active",
            lastDeposit: "2023-10-15",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 5,
            fullName: "David Brown",
            username: "davidb",
            email: "david@example.com",
            phone: "08056789012",
            dailyProposedAmount: 800,
            balance: 12000,
            status: "inactive",
            lastDeposit: "2023-09-30",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 6,
            fullName: "Grace Okafor",
            username: "graceo",
            email: "grace@example.com",
            phone: "08067890123",
            dailyProposedAmount: 3000,
            balance: 65700,
            status: "active",
            lastDeposit: "2023-10-14",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 7,
            fullName: "Peter Okonkwo",
            username: "petero",
            email: "peter@example.com",
            phone: "08078901234",
            dailyProposedAmount: 1200,
            balance: 34000,
            status: "active",
            lastDeposit: "2023-10-12",
            role: "agent",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }, {
            id: 8,
            fullName: "Mary Emmanuel",
            username: "marye",
            email: "mary@example.com",
            phone: "08089012345",
            dailyProposedAmount: 600,
            balance: 12300,
            status: "active",
            lastDeposit: "2023-10-15",
            role: "user",
            depositCalendar: {},
            withdrawalCalendar: {},
            transactions: []
        }];

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return₦ $ {
                amount.toLocaleString('en-NG')
            };
        }

        function formatDate(dateString) {
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            return new Date(dateString).toLocaleDateString('en-NG', options);
        }

        function getTodayDate() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return now.toLocaleDateString('en-NG', options);
        }

        function generateTransactionId() {
            return 'HFCA-TX-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }

        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<span>${message}</span><button class="notification-close">&times;</button>`;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);

            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            });
        }

        function addNotificationStyles() {
            if (document.querySelector('#notification-styles')) return;

            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification-info { background: linear-gradient(to right, #2563eb, #1e40af); }
        .notification-success { background: linear-gradient(to right, #10b981, #059669); }
        .notification-error { background: linear-gradient(to right, #dc2626, #b91c1c); }
        .notification-warning { background: linear-gradient(to right, #f59e0b, #d97706); }
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 15px;
            line-height: 1;
        }
        @media (max-width: 768px) {
            .notification {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
    `;
            document.head.appendChild(style);
        }

        // ===== PAGE MANAGEMENT =====
        function showPage(pageId) {
            // Hide all pages
            const pages = ['loginPage', 'adminPage', 'userPage'];
            pages.forEach(page => {
                const element = document.getElementById(page);
                if (element) element.style.display = 'none';
            });

            // Show requested page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                window.scrollTo(0, 0);

                // Initialize page specific functions
                if (pageId === 'adminPage') initAdminPage();
                if (pageId === 'userPage') initUserPage();
            }
        }

        // ===== AUTHENTICATION =====
        function checkAuth() {
            const savedUser = localStorage.getItem('happyfamily_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.role === 'admin') {
                    showPage('adminPage');
                } else {
                    showPage('userPage');
                }
                updateUserUI();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'admin123') {
                currentUser = {
                    id: 0,
                    fullName: 'Admin User',
                    username: 'admin',
                    role: 'admin',
                    email: 'admin@happyfamily.com'
                };
                localStorage.setItem('happyfamily_user', JSON.stringify(currentUser));
                showNotification('Welcome back, Admin!', 'success');
                setTimeout(() => showPage('adminPage'), 500);
            } else if (username === 'user1' && password === 'user123') {
                currentUser = demoUsers[0];
                currentUser.role = 'user';
                localStorage.setItem('happyfamily_user', JSON.stringify(currentUser));
                showNotification('Login successful!', 'success');
                setTimeout(() => showPage('userPage'), 500);
            } else {
                showNotification('Invalid username or password. Use demo credentials.', 'error');
            }
        }

        function handleLogout() {
            localStorage.removeItem('happyfamily_user');
            currentUser = null;
            showNotification('Logged out successfully', 'info');
            setTimeout(() => {
                showPage('loginPage');
                const loginForm = document.getElementById('loginForm');
                if (loginForm) loginForm.reset();
            }, 500);
        }

        function updateUserUI() {
            if (!currentUser) return;
            const userNameElements = document.querySelectorAll('#currentUserName, #displayUserName');
            userNameElements.forEach(el => {
                if (el) el.textContent = currentUser.fullName;
            });
        }

        // ===== ADMIN PAGE FUNCTIONS =====
        function loadUsersTable() {
            const tableBody = document.getElementById('userTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';
            demoUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>HFCA-${user.id.toString().padStart(4, '0')}</td>
            <td>${user.fullName}</td>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${formatCurrency(user.dailyProposedAmount)}</td>
            <td>${formatCurrency(user.balance)}</td>
            <td>${formatDate(user.lastDeposit)}</td>
            <td><span class="${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                <i class="fas ${user.status === 'active' ? 'fa-circle' : 'fa-circle'}"></i> ${user.status === 'active' ? 'Active' : 'Inactive'}
            </span></td>
            <td>
                <button class="btn-action btn-view" onclick="viewUserDetails(${user.id})">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn-action btn-edit" onclick="editUser(${user.id})">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn-action btn-delete" onclick="deleteUser(${user.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn-action" onclick="openDepositModal(${user.id})" style="background-color: #10b981; color: white;">
                    <i class="fas fa-money-bill-wave"></i> Deposit
                </button>
                <button class="btn-action btn-delete" onclick="openWithdrawalModal(${user.id})">
                    <i class="fas fa-hand-holding-usd"></i> Withdraw
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
            updateAdminStats();
        }

        function updateAdminStats() {
            const totalUsers = demoUsers.length;
            const totalBalance = demoUsers.reduce((sum, user) => sum + user.balance, 0);
            const today = new Date().toISOString().split('T')[0];
            const todayDeposits = demoUsers
                .filter(user => user.lastDeposit === today)
                .reduce((sum, user) => sum + user.dailyProposedAmount, 0);

            const totalUsersEl = document.getElementById('totalUsers');
            const totalBalanceEl = document.getElementById('totalBalance');
            const todayDepositsEl = document.getElementById('todayDeposits');

            if (totalUsersEl) totalUsersEl.textContent = totalUsers;
            if (totalBalanceEl) totalBalanceEl.textContent = formatCurrency(totalBalance);
            if (todayDepositsEl) todayDepositsEl.textContent = formatCurrency(todayDeposits);
        }

        function viewUserDetails(userId) {
            const user = demoUsers.find(u => u.id === userId);
            if (!user) return;
            showNotification(Viewing details
                for $ {
                    user.fullName
                }, 'info');
            const formatAmount = amt => (typeof amt === 'number' ? '₦' + amt.toLocaleString('en-NG') : amt);
            const formatDateSafe = d => {
                try {
                    return formatDate(d);
                } catch {
                    return d || 'N/A';
                }
            };

            const details = [
                'User Details:',
                '',
                `Name: ${user.fullName}`,
                `Username: ${user.username}`,
                `Email: ${user.email}`,
                `Phone: ${user.phone}`,
                `Daily Amount: ${formatAmount(user.dailyProposedAmount)}`,
                `Balance: ${formatAmount(user.balance)}`,
                `Status: ${user.status}`,
                `Last Deposit: ${formatDateSafe(user.lastDeposit)}`
            ].join('\n');

            alert(details);
        }

        function editUser(userId) {
            const user = demoUsers.find(u => u.id === userId);
            if (!user) return;
            showNotification(Editing user: $ {
                user.fullName
            }, 'info');
            alert(Edit functionality
                for $ {
                    user.fullName
                }
                would open here.);
        }

        function deleteUser(userId) {
            const user = demoUsers.find(u => u.id === userId);
            if (!user) return;
            if (confirm(Are you sure you want to delete user $ {
                    user.fullName
                } ? )) {
                showNotification(User $ {
                        user.fullName
                    }
                    deleted successfully, 'success');
            }
        }

        function addNewUser(userData) {
            const newId = Math.max(...demoUsers.map(u => u.id)) + 1;
            const newUser = {
                id: newId,
                fullName: userData.fullName,
                username: userData.username,
                email: userData.email || $ {
                    userData.username
                }
                @example.com,
                phone: userData.phone,
                dailyProposedAmount: parseInt(userData.dailyProposedAmount) || 1000,
                balance: 0,
                status: 'active',
                lastDeposit: new Date().toISOString().split('T')[0],
                role: userData.role || 'user',
                depositCalendar: {},
                withdrawalCalendar: {},
                transactions: []
            };

            demoUsers.push(newUser);
            loadUsersTable();
            showNotification(User $ {
                    userData.fullName
                }
                registered successfully, 'success');
        }

        function handleUserSearch() {
            const searchInput = document.getElementById('userSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#userTableBody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // ===== DEPOSIT/WITHDRAWAL SYSTEM =====
        function getMonthName(monthNumber) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthNumber - 1] || '';
        }

        function generateDateKey(year, month, day) {
            return $ {
                year
            } - $ {
                month.toString().padStart(2, '0')
            } - $ {
                day.toString().padStart(2, '0')
            };
        }

        function isToday(year, month, day) {
            const today = new Date();
            return today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === day;
        }

        function isDateDeposited(user, year, month, day) {
            const dateKey = generateDateKey(year, month, day);
            return user.depositCalendar && user.depositCalendar[dateKey] === true;
        }

        function isDateWithdrawn(user, year, month, day) {
            const dateKey = generateDateKey(year, month, day);
            return user.withdrawalCalendar && user.withdrawalCalendar[dateKey] === true;
        }

        function createMonthCalendar(user, year, month, isDepositMode = true) {
            const monthName = getMonthName(month);
            const daysInMonth = 31; // Always 31 days as requested

            let depositedDays = 0;
            let totalAmount = 0;

            // Calculate stats for this month
            for (let day = 1; day <= daysInMonth; day++) {
                if (isDateDeposited(user, year, month, day)) {
                    depositedDays++;
                    totalAmount += user.dailyProposedAmount;
                }
            }

            // Create checkboxes
            let checkboxesHTML = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const isTodayDate = isToday(year, month, day);
                const isDeposited = isDateDeposited(user, year, month, day);
                const isWithdrawn = isDateWithdrawn(user, year, month, day);

                let checkboxClass = 'checkbox-day';
                if (isTodayDate) checkboxClass += ' today';
                if (isDeposited) checkboxClass += ' deposited';
                if (isWithdrawn) checkboxClass += ' withdrawn';

                const checkboxId = day - $ {
                    year
                } - $ {
                    month
                } - $ {
                    day
                };
                const isChecked = isDepositMode ? isDeposited : (isDeposited && !isWithdrawn);
                const isDisabled = isDepositMode ? (isDeposited || isWithdrawn) : (!isDeposited || isWithdrawn);

                checkboxesHTML += `
            <div class="${checkboxClass}">
                <label for="${checkboxId}">${day}</label>
                <input type="checkbox" 
                       id="${checkboxId}" 
                       data-year="${year}" 
                       data-month="${month}" 
                       data-day="${day}"
                       ${isChecked ? 'checked' : ''}
                       ${isDisabled ? 'disabled' : ''}
                       ${isDepositMode ? 'onchange="handleDepositCheckboxChange(this)"' : 'onchange="handleWithdrawalCheckboxChange(this)"'}>
            </div>
        `;
            }

            return `
        <div class="month-section">
            <div class="month-header">
                <h4><i class="fas fa-calendar-alt"></i> ${monthName} ${year}</h4>
                <div class="check-all-container">
                    <label>
                        <input type="checkbox" 
                               id="check-all-${year}-${month}" 
                               data-year="${year}" 
                               data-month="${month}"
                               onchange="handleCheckAll(this, ${isDepositMode})">
                        Check All
                    </label>
                </div>
            </div>
            <div class="checkbox-grid">
                ${checkboxesHTML}
            </div>
            <div class="month-summary">
                <div class="summary-item">
                    <span class="summary-label">Days ${isDepositMode ? 'Deposited' : 'Withdrawn'}</span>
                    <span class="summary-value">${depositedDays}/${daysInMonth}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total Amount</span>
                    <span class="summary-value">${formatCurrency(totalAmount)}</span>
                </div>
            </div>
        </div>
    `;
        }

        function handleCheckAll(checkbox, isDepositMode) {
            const year = parseInt(checkbox.dataset.year);
            const month = parseInt(checkbox.dataset.month);
            const isChecked = checkbox.checked;

            for (let day = 1; day <= 31; day++) {
                const checkboxId = day - $ {
                    year
                } - $ {
                    month
                } - $ {
                    day
                };
                const dayCheckbox = document.getElementById(checkboxId);
                if (dayCheckbox && !dayCheckbox.disabled) {
                    dayCheckbox.checked = isChecked;
                    if (isDepositMode) {
                        handleDepositCheckboxChange(dayCheckbox);
                    } else {
                        handleWithdrawalCheckboxChange(dayCheckbox);
                    }
                }
            }
            updateCalendarTotals(isDepositMode);
        }

        function handleDepositCheckboxChange(checkbox) {
            updateCalendarTotals(true);
        }

        function handleWithdrawalCheckboxChange(checkbox) {
            if (!checkbox.checked) {
                const year = parseInt(checkbox.dataset.year);
                const month = parseInt(checkbox.dataset.month);
                const day = parseInt(checkbox.dataset.day);

                if (selectedUserForCalendar && isDateDeposited(selectedUserForCalendar, year, month, day)) {
                    checkbox.checked = true;
                    showNotification('Cannot withdraw from a day that was not deposited', 'error');
                    return;
                }
            }
            updateCalendarTotals(false);
        }

        function updateCalendarTotals(isDepositMode) {
            if (!selectedUserForCalendar) return;

            const user = selectedUserForCalendar;
            let totalAmount = 0;
            const containerId = isDepositMode ? 'depositMonthsContainer' : 'withdrawalMonthsContainer';
            const container = document.getElementById(containerId);
            if (!container) return;

            // Get all checkboxes in the container
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked && !checkbox.disabled) {
                    totalAmount += user.dailyProposedAmount;
                }
            });

            const totalElement = isDepositMode ?
                document.getElementById('depositYearlyTotal') :
                document.getElementById('withdrawalYearlyTotal');

            if (totalElement) {
                totalElement.textContent = formatCurrency(totalAmount);
            }
        }

        function openDepositModal(userId) {
            const user = demoUsers.find(u => u.id === userId);
            if (!user) return;

            selectedUserForCalendar = user;

            // Update modal info
            const depositUserName = document.getElementById('depositUserName');
            const depositUserAmount = document.getElementById('depositUserAmount');
            if (depositUserName) depositUserName.textContent = user.fullName;
            if (depositUserAmount) depositUserAmount.textContent = Daily Amount: $ {
                formatCurrency(user.dailyProposedAmount)
            };

            // Generate year options
            const yearSelect = document.getElementById('depositYearSelect');
            if (yearSelect) {
                yearSelect.innerHTML = '';
                for (let year = 2023; year <= 2025; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
            }

            // Generate calendar for 24 months
            const monthsContainer = document.getElementById('depositMonthsContainer');
            if (monthsContainer) {
                monthsContainer.innerHTML = '';
                for (let month = 1; month <= 24; month++) {
                    const actualMonth = month <= 12 ? month : month - 12;
                    const actualYear = month <= 12 ? currentYear : currentYear + 1;
                    monthsContainer.innerHTML += createMonthCalendar(user, actualYear, actualMonth, true);
                }
            }

            updateCalendarTotals(true);
            document.getElementById('depositModal').style.display = 'flex';
        }

        function openWithdrawalModal(userId) {
            const user = demoUsers.find(u => u.id === userId);
            if (!user) return;

            selectedUserForCalendar = user;

            // Update modal info
            const withdrawalUserName = document.getElementById('withdrawalUserName');
            const withdrawalUserAmount = document.getElementById('withdrawalUserAmount');
            if (withdrawalUserName) withdrawalUserName.textContent = user.fullName;
            if (withdrawalUserAmount) withdrawalUserAmount.textContent = Daily Amount: $ {
                formatCurrency(user.dailyProposedAmount)
            };

            // Generate year options
            const yearSelect = document.getElementById('withdrawalYearSelect');
            if (yearSelect) {
                yearSelect.innerHTML = '';
                for (let year = 2023; year <= 2025; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
            }

            // Generate calendar for 24 months
            const monthsContainer = document.getElementById('withdrawalMonthsContainer');
            if (monthsContainer) {
                monthsContainer.innerHTML = '';
                for (let month = 1; month <= 24; month++) {
                    const actualMonth = month <= 12 ? month : month - 12;
                    const actualYear = month <= 12 ? currentYear : currentYear + 1;
                    monthsContainer.innerHTML += createMonthCalendar(user, actualYear, actualMonth, false);
                }
            }

            updateCalendarTotals(false);
            document.getElementById('withdrawalModal').style.display = 'flex';
        }

        function saveDepositChanges() {
            if (!selectedUserForCalendar) return;

            const user = selectedUserForCalendar;
            const monthsContainer = document.getElementById('depositMonthsContainer');
            if (!monthsContainer) return;

            const checkboxes = monthsContainer.querySelectorAll('input[type="checkbox"]');
            let changesMade = false;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked && !checkbox.disabled) {
                    const year = parseInt(checkbox.dataset.year);
                    const month = parseInt(checkbox.dataset.month);
                    const day = parseInt(checkbox.dataset.day);
                    const dateKey = generateDateKey(year, month, day);

                    // Only update if not already deposited
                    if (!user.depositCalendar[dateKey]) {
                        user.depositCalendar[dateKey] = true;
                        changesMade = true;

                        // Add transaction
                        const transaction = {
                            id: generateTransactionId(),
                            date: dateKey,
                            description: 'Daily Contribution',
                            amount: user.dailyProposedAmount,
                            type: 'deposit',
                            balanceAfter: user.balance + user.dailyProposedAmount
                        };

                        user.transactions.push(transaction);
                        user.balance += user.dailyProposedAmount;
                        user.lastDeposit = dateKey;
                    }
                }
            });

            if (changesMade) {
                showNotification(Deposits saved
                    for $ {
                        user.fullName
                    }, 'success');
                loadUsersTable();
                if (currentUser && currentUser.id === user.id) {
                    updateUserDashboard();
                }
            }

            document.getElementById('depositModal').style.display = 'none';
            selectedUserForCalendar = null;
        }

        function saveWithdrawalChanges() {
            if (!selectedUserForCalendar) return;

            const user = selectedUserForCalendar;
            const monthsContainer = document.getElementById('withdrawalMonthsContainer');
            const reasonInput = document.getElementById('withdrawalReason');
            const reason = reasonInput ? reasonInput.value.trim() : '';

            if (!monthsContainer) return;

            const checkboxes = monthsContainer.querySelectorAll('input[type="checkbox"]');
            let withdrawalsMade = 0;

            checkboxes.forEach(checkbox => {
                if (!checkbox.checked && !checkbox.disabled) {
                    const year = parseInt(checkbox.dataset.year);
                    const month = parseInt(checkbox.dataset.month);
                    const day = parseInt(checkbox.dataset.day);
                    const dateKey = generateDateKey(year, month, day);

                    // Only withdraw if deposited and not already withdrawn
                    if (user.depositCalendar[dateKey] && !user.withdrawalCalendar[dateKey]) {
                        user.withdrawalCalendar[dateKey] = true;
                        withdrawalsMade++;

                        // Add withdrawal transaction
                        const transaction = {
                            id: generateTransactionId(),
                            date: new Date().toISOString().split('T')[0],
                            description: Withdrawal$ {
                                reason ? ': ' + reason : ''
                            },
                            amount: user.dailyProposedAmount,
                            type: 'withdrawal',
                            balanceAfter: user.balance - user.dailyProposedAmount
                        };

                        user.transactions.push(transaction);
                        user.balance -= user.dailyProposedAmount;
                    }
                }
            });

            if (withdrawalsMade > 0) {
                showNotification($ {
                        withdrawalsMade
                    }
                    withdrawals saved
                    for $ {
                        user.fullName
                    }, 'success');
                loadUsersTable();
                if (currentUser && currentUser.id === user.id) {
                    updateUserDashboard();
                }
            } else {
                showNotification('No withdrawals to save', 'info');
            }

            if (reasonInput) reasonInput.value = '';
            document.getElementById('withdrawalModal').style.display = 'none';
            selectedUserForCalendar = null;
        }

        // ===== MODAL SETUP =====
        function setupAdminModal() {
            const modal = document.getElementById('userModal');
            const addUserBtn = document.getElementById('addUserBtn');
            const closeModalBtn = document.getElementById('closeModal');
            const cancelModalBtn = document.getElementById('cancelModal');
            const addUserForm = document.getElementById('addUserForm');

            if (!modal || !addUserBtn || !addUserForm) return;

            addUserBtn.addEventListener('click', () => {
                modal.style.display = 'flex';
                document.getElementById('newFullName').focus();
            });

            function closeModal() {
                modal.style.display = 'none';
                addUserForm.reset();
            }

            if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (cancelModalBtn) cancelModalBtn.addEventListener('click', closeModal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            addUserForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const userData = {
                    fullName: document.getElementById('newFullName').value.trim(),
                    username: document.getElementById('newUsername').value.trim(),
                    email: document.getElementById('newEmail').value.trim(),
                    phone: document.getElementById('newPhone').value.trim(),
                    dailyProposedAmount: document.getElementById('dailyProposedAmount').value,
                    role: document.getElementById('userRole').value
                };

                if (!userData.fullName || !userData.username || !userData.phone) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                if (parseInt(userData.dailyProposedAmount) < 200) {
                    showNotification('Daily proposed amount must be at least ₦200', 'error');
                    return;
                }

                addNewUser(userData);
                closeModal();
            });
        }

        function setupDepositModal() {
            const modal = document.getElementById('depositModal');
            const closeBtn = document.getElementById('closeDepositModal');
            const cancelBtn = document.getElementById('cancelDepositModal');
            const confirmBtn = document.getElementById('confirmDepositModal');
            const saveBtn = document.getElementById('saveDepositsBtn');
            const yearSelect = document.getElementById('depositYearSelect');

            if (!modal) return;

            function closeModal() {
                modal.style.display = 'none';
                selectedUserForCalendar = null;
            }

            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            if (yearSelect) {
                yearSelect.addEventListener('change', function() {
                    currentYear = parseInt(this.value);
                    if (selectedUserForCalendar) {
                        openDepositModal(selectedUserForCalendar.id);
                    }
                });
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveDepositChanges);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to save these deposit changes?')) {
                        saveDepositChanges();
                    }
                });
            }
        }

        function setupWithdrawalModal() {
            const modal = document.getElementById('withdrawalModal');
            const closeBtn = document.getElementById('closeWithdrawalModal');
            const cancelBtn = document.getElementById('cancelWithdrawalModal');
            const confirmBtn = document.getElementById('confirmWithdrawalModal');
            const saveBtn = document.getElementById('saveWithdrawalsBtn');
            const yearSelect = document.getElementById('withdrawalYearSelect');

            if (!modal) return;

            function closeModal() {
                modal.style.display = 'none';
                selectedUserForCalendar = null;
                const reasonInput = document.getElementById('withdrawalReason');
                if (reasonInput) reasonInput.value = '';
            }

            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            if (yearSelect) {
                yearSelect.addEventListener('change', function() {
                    currentYear = parseInt(this.value);
                    if (selectedUserForCalendar) {
                        openWithdrawalModal(selectedUserForCalendar.id);
                    }
                });
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveWithdrawalChanges);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    const reasonInput = document.getElementById('withdrawalReason');
                    const reason = reasonInput ? reasonInput.value.trim() : '';
                    if (confirm(Are you sure you want to save these withdrawal changes ? $ {
                            reason ? '\nReason: ' + reason : ''
                        })) {
                        saveWithdrawalChanges();
                    }
                });
            }
        }

        // ===== USER DASHBOARD FUNCTIONS =====
        function loadUserTransactions() {
            const tableBody = document.getElementById('transactionTableBody');
            if (!tableBody || !currentUser) return;

            const user = demoUsers.find(u => u.id === currentUser.id);
            if (!user) return;

            tableBody.innerHTML = '';

            // Sort transactions by date (newest first)
            const sortedTransactions = [...user.transactions].sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            ).slice(0, 10);

            sortedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${formatDate(transaction.date)}</td>
            <td>${transaction.id}</td>
            <td>${transaction.description}</td>
            <td>${formatCurrency(transaction.amount)}</td>
            <td><span class="${transaction.type === 'deposit' ? 'type-deposit' : 'type-withdrawal'}">
                ${transaction.type === 'deposit' ? 'Deposit' : 'Withdrawal'}
            </span></td>
            <td>${formatCurrency(transaction.balanceAfter)}</td>
        `;
                tableBody.appendChild(row);
            });

            updateUserBalance();
            updateUserStats();
        }

        function updateUserBalance() {
            if (!currentUser) return;
            const user = demoUsers.find(u => u.id === currentUser.id);
            if (!user) return;

            const balanceElement = document.getElementById('currentBalance');
            const dailyTargetElement = document.getElementById('dailyTargetAmount');

            if (balanceElement) balanceElement.textContent = formatCurrency(user.balance);
            if (dailyTargetElement) dailyTargetElement.textContent = formatCurrency(user.dailyProposedAmount);
        }

        function updateUserStats() {
            if (!currentUser) return;
            const user = demoUsers.find(u => u.id === currentUser.id);
            if (!user) return;

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;

            let monthlyDeposits = 0;
            let monthlyAmount = 0;

            // Calculate monthly deposits
            for (let day = 1; day <= 31; day++) {
                if (isDateDeposited(user, currentYear, currentMonth, day)) {
                    monthlyDeposits++;
                    monthlyAmount += user.dailyProposedAmount;
                }
            }

            // Update UI elements
            const contributionsElement = document.getElementById('contributionsThisMonth');
            const totalElement = document.getElementById('totalThisMonth');
            const progressElement = document.getElementById('monthProgress');
            const progressTextElement = document.getElementById('monthProgressText');
            const total30DaysElement = document.getElementById('totalDeposits30Days');

            if (contributionsElement) contributionsElement.textContent = $ {
                monthlyDeposits
            }
            /31 days;
            if (totalElement) totalElement.textContent = formatCurrency(monthlyAmount);

            if (progressElement) {
                const progressPercentage = Math.round((monthlyDeposits / 31) * 100);
                progressElement.style.width = $ {
                    progressPercentage
                } % ;
            }

            if (progressTextElement) {
                const progressPercentage = Math.round((monthlyDeposits / 31) * 100);
                progressTextElement.textContent = $ {
                    progressPercentage
                } % monthly target achieved;
            }

            if (total30DaysElement) {
                // Calculate last 30 days deposits
                let last30DaysAmount = 0;
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                user.transactions.forEach(transaction => {
                    if (transaction.type === 'deposit') {
                        const transactionDate = new Date(transaction.date);
                        if (transactionDate >= thirtyDaysAgo) {
                            last30DaysAmount += transaction.amount;
                        }
                    }
                });

                total30DaysElement.textContent = formatCurrency(last30DaysAmount);
            }

            // Update today's status
            const todayInfoElement = document.getElementById('todayContributionInfo');
            if (todayInfoElement) {
                const todayDeposited = isDateDeposited(user, today.getFullYear(), today.getMonth() + 1, today.getDate());
                todayInfoElement.textContent = todayDeposited ?
                    Today, $ {
                        today.getHours().toString().padStart(2, '0')
                    } : $ {
                        today.getMinutes().toString().padStart(2, '0')
                    }
                at Main Branch:
                    'Not yet deposited today';
            }
        }

        function setupTimeFilter() {
            const timeFilter = document.getElementById('timeFilter');
            if (!timeFilter) return;

            timeFilter.addEventListener('change', function() {
                const days = parseInt(this.value);
                showNotification(Filtering transactions
                    for last $ {
                        days
                    }
                    days, 'info');
                loadUserTransactions();
            });
        }

        function updateUserDashboard() {
            loadUserTransactions();
            updateUserBalance();
            updateUserStats();
        }

        // ===== INITIALIZATION =====
        function initAdminPage() {
            if (currentUser && currentUser.role !== 'admin') {
                showNotification('Access denied. Admin privileges required.', 'error');
                setTimeout(() => showPage('userPage'), 2000);
                return;
            }

            loadUsersTable();
            handleUserSearch();
            setupAdminModal();
            setupDepositModal();
            setupWithdrawalModal();

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            // Setup calendar buttons
            const manageDepositsBtn = document.getElementById('manageDepositsBtn');
            const manageWithdrawalsBtn = document.getElementById('manageWithdrawalsBtn');

            if (manageDepositsBtn) {
                manageDepositsBtn.addEventListener('click', () => {
                    showNotification('Please select a user from the table to manage deposits', 'info');
                });
            }

            if (manageWithdrawalsBtn) {
                manageWithdrawalsBtn.addEventListener('click', () => {
                    showNotification('Please select a user from the table to manage withdrawals', 'info');
                });
            }
        }

        function initUserPage() {
            if (!currentUser) return;

            const todayDateElement = document.getElementById('todayDate');
            if (todayDateElement) todayDateElement.textContent = getTodayDate();

            setupTimeFilter();
            updateUserDashboard();

            const logoutBtn = document.getElementById('userLogoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            const receiptBtn = document.querySelector('.btn-receipt');
            if (receiptBtn) {
                receiptBtn.addEventListener('click', () => {
                    const user = demoUsers.find(u => u.id === currentUser.id);
                    if (user) {
                        const todayDeposited = isDateDeposited(user, new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
                        if (todayDeposited) {
                            showNotification('Today\'s receipt downloaded successfully', 'success');
                        } else {
                            showNotification('No deposit made today', 'warning');
                        }
                    }
                });
            }
        }

        // ===== MAIN INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Add notification styles
            addNotificationStyles();

            // Check authentication
            checkAuth();

            // Initialize login page
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // Register link
            const registerLink = document.getElementById('registerLink');
            if (registerLink) {
                registerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showNotification('Only administrators can register new users. Please contact your branch administrator.', 'info');
                });
            }

            // Make functions available globally
            window.viewUserDetails = viewUserDetails;
            window.editUser = editUser;
            window.deleteUser = deleteUser;
            window.openDepositModal = openDepositModal;
            window.openWithdrawalModal = openWithdrawalModal;
            window.showPage = showPage;
            window.handleCheckAll = handleCheckAll;
            window.handleDepositCheckboxChange = handleDepositCheckboxChange;
            window.handleWithdrawalCheckboxChange = handleWithdrawalCheckboxChange;
        });
    </script>
</body>

</html>